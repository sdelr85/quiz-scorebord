<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Nostra – Scorebord</title>

  <style>
    :root{
      /* Branding */
      --quiz-red:#E53935;
      --spes-green:#2E7D32;
      --spes-green-dark:#1B5E20;
      --spes-yellow:#FDD835;
      --light-green:#A5D6A7;

      /* UI */
      --bg:#f6f7f8;
      --card:#fff;
      --text:#222;
      --muted:#60666d;
      --line:#e1e2e5;

      /* Badges */
      --rank-default-bg:#D9EBD9;   /* zachte variant van groen */
      --rank-default-fg:#1B5E20;   /* donker groen voor cijfer */
    }

    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    /* Header */
    .site-header{ background:#fff; border-bottom:4px solid var(--spes-green); padding:20px; }
    .brand{ max-width:1050px; margin:0 auto; display:flex; align-items:center; gap:20px; }
    .brand__logo{ height:clamp(64px,8vw,96px); width:auto; object-fit:contain; }
    .brand__titles{ display:flex; flex-direction:column; gap:4px; }
    .brand__title{ margin:0; font-size:clamp(32px,4vw,48px); color:var(--quiz-red); font-weight:900; line-height:1.1; }
    .brand__subtitle{ margin:0; color:var(--muted); }

    /* Actions */
    .actions{ max-width:1050px; margin:16px auto; padding:0 20px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn{ padding:10px 16px; border-radius:10px; border:2px solid transparent; font-size:15px; font-weight:600; cursor:pointer; transition:.2s; }
    .btn-primary{ background:var(--spes-green); color:#fff; }
    .btn-secondary{ background:#fff; border:2px solid var(--light-green); color:var(--spes-green); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    #meta{ text-align:center; color:var(--muted); font-size:13px; margin-top:-4px; margin-bottom:12px; }

    /* Lijst */
    .wrap{ max-width:1050px; margin:0 auto; padding:0 20px 40px; }
    .grid{ display:grid; gap:14px; }

    /* Kaart in kolommen:
       [ rank | teamnaam | balk | score ] */
    .card{
      display:grid;
      grid-template-columns: 64px minmax(180px, 1.6fr) 4fr 70px;
      align-items:center;
      gap:14px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 16px;
      box-shadow:0 2px 2px rgba(0,0,0,.03), 0 5px 14px rgba(0,0,0,.05);
    }

    /* Rang-badge */
    .place{
      width:48px; height:48px; border-radius:12px;
      display:grid; place-items:center;
      font-weight:800; font-size:20px;
      color:var(--rank-default-fg);
      background:var(--rank-default-bg);
      border:2px solid #cfe2cf;
      justify-self:center;
    }
    .place.gold  { background:linear-gradient(135deg, var(--spes-yellow), #ffb300); color:#333; border:none; }
    .place.silver{ background:linear-gradient(135deg, #e0e0e0, #bdbdbd); color:#333; border:none; }
    .place.bronze{ background:linear-gradient(135deg, #ffcc80, #fb8c00); color:#333; border:none; }

    /* Teamnaam – enkel-lijn, ellipsis, iets flexibeler font */
    .team{
      font-weight:800;
      font-size:clamp(16px, 2.1vw, 20px);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .team a{ color:var(--text); text-decoration:none; }
    .team a:hover{ text-decoration:underline; }

    /* Balk – korter omdat hij zijn eigen kolom heeft */
    .bar-wrap{ width:100%; height:10px; background:#efefef; border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:var(--spes-green); transition:width .5s ease; }

    .score{ text-align:right; font-size:22px; font-weight:800; color:var(--text); }
  </style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <img src="assets/ouderraad-logo.png" alt="Ouderraad Spes Nostra Kuurne" class="brand__logo">
    <div class="brand__titles">
      <h1 class="brand__title">Quiz Nostra</h1>
      <p class="brand__subtitle">Live scorebord</p>
    </div>
  </div>
</header>

<div class="actions">
  <button id="btnAdd"   class="btn btn-primary">+ Voeg team toe</button>
  <button id="btnUndo"  class="btn btn-secondary">– Verwijder laatste</button>
  <button id="btnAll"   class="btn btn-secondary">Toon alle teams</button>
  <button id="btnReset" class="btn btn-secondary">Reset</button>
</div>

<div id="meta">Laden…</div>

<div class="wrap"><div id="list" class="grid"></div></div>

<script>
/* === CONFIG === */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";
const REFRESH_MS = 5000;

/* === STATE === */
let fullData = [];
let visibleCount = 0;

/* Helpers */
function roundNumberFromName(n){ const m = String(n).toLowerCase().match(/r(?:onde)?\s*(\d+)/); return m?parseInt(m[1],10):null; }
async function fetchCSV(u){ const r = await fetch(u + "&_t=" + Date.now(), {cache:"no-store"}); if(!r.ok) throw new Error("CSV ophalen mislukt"); return await r.text(); }

function parseCSV(text){
  const rows = text.trim().replace(/^\uFEFF/,"").split(/\r?\n/)
    .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x => x.replace(/^"|"$/g,"").trim()));
  if(!rows.length) return [];
  const headers = rows[0].map(h=>h.trim());
  const hLow = headers.map(h=>h.toLowerCase());
  const teamIdx  = hLow.indexOf("team");
  const tokenIdx = hLow.indexOf("token");
  const scoreIdx = hLow.indexOf("score");
  const roundCols = headers.map((h,i)=>({label:h,i,nr:roundNumberFromName(h)})).filter(o=>o.nr!==null).sort((a,b)=>a.nr-b.nr);

  const data = rows.slice(1).map(r=>{
    const team  = teamIdx>=0 ? (r[teamIdx]||"") : "";
    const token = tokenIdx>=0 ? (r[tokenIdx]||"") : "";
    let total=0;
    if(roundCols.length>0){ for(const c of roundCols){ total += Number((r[c.i]||"0").replace(",","."))||0; } }
    else if(scoreIdx>=0){ total = Number((r[scoreIdx]||"0").replace(",","."))||0; }
    return {team, token, total};
  }).filter(x=>x.team);

  return data;
}

function computeRanks(list){
  list.sort((a,b)=> b.total - a.total || a.team.localeCompare(b.team,'nl'));
  let prev=null, rank=0;
  list.forEach((x,i)=>{ if(prev===null||x.total<prev) rank=i+1; x.rank=rank; prev=x.total; });
  return list;
}

function render(list){
  const root = document.getElementById("list");
  root.innerHTML = "";
  const toShow = list.slice(-visibleCount);
  const max = Math.max(1, ...toShow.map(x=>x.total));

  toShow.forEach(row=>{
    const card = document.createElement("div");
    card.className = "card";

    const place = document.createElement("div");
    place.className = "place";
    if(row.rank===1) place.classList.add("gold");
    else if(row.rank===2) place.classList.add("silver");
    else if(row.rank===3) place.classList.add("bronze");
    place.textContent = row.rank;

    const team = document.createElement("div");
    team.className = "team";
    const a = document.createElement("a");
    const q = row.token ? ("t="+encodeURIComponent(row.token)) : ("team="+encodeURIComponent(row.team));
    a.href = "team.html?"+q;
    a.textContent = row.team;
    team.appendChild(a);

    const barWrap = document.createElement("div");
    barWrap.className = "bar-wrap";
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = Math.round((row.total / max) * 100) + "%";
    barWrap.appendChild(bar);

    const score = document.createElement("div");
    score.className = "score";
    score.textContent = row.total;

    card.appendChild(place);
    card.appendChild(team);
    card.appendChild(barWrap);
    card.appendChild(score);
    root.appendChild(card);
  });

  const meta = document.getElementById("meta");
  meta.textContent = (toShow.length ? `Getoond: ${toShow.length}/${list.length} – ` : "")
                   + "Laatst bijgewerkt: " + new Date().toLocaleTimeString();

  btnAdd.disabled   = visibleCount >= list.length;
  btnUndo.disabled  = visibleCount <= 0;
  btnAll.disabled   = visibleCount >= list.length;
  btnReset.disabled = visibleCount <= 0;
}

async function tick(){
  try{
    const csv = await fetchCSV(CSV_URL);
    fullData = computeRanks(parseCSV(csv));
    if(visibleCount > fullData.length) visibleCount = fullData.length;
    render(fullData);
  }catch(e){
    console.error(e);
    document.getElementById("meta").textContent = "Fout bij laden: " + (e.message||e);
  }finally{
    setTimeout(tick, REFRESH_MS);
  }
}

/* Controls */
const btnAdd=document.getElementById("btnAdd");
const btnUndo=document.getElementById("btnUndo");
const btnAll=document.getElementById("btnAll");
const btnReset=document.getElementById("btnReset");

btnAdd.onclick  = ()=>{ visibleCount = Math.min(visibleCount+1, fullData.length); render(fullData); };
btnUndo.onclick = ()=>{ visibleCount = Math.max(visibleCount-1, 0); render(fullData); };
btnAll.onclick  = ()=>{ visibleCount = fullData.length; render(fullData); };
btnReset.onclick= ()=>{ visibleCount = 0; render(fullData); };

/* Start */
tick();
</script>
</body>
</html>