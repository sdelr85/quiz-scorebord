<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Nostra – Scorebord</title>

  <style>
    :root {
      --quiz-red: #E53935;
      --spes-green: #2E7D32;
      --spes-yellow: #FDD835;
      --light-green: #A5D6A7;

      --bg: #f6f7f8;
      --card: #ffffff;
      --text: #222;
      --muted: #60666d;
      --line: #e1e2e5;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    /* HEADER */
    .site-header {
      background: white;
      border-bottom: 4px solid var(--spes-green);
      padding: 18px 20px;
    }
    .brand {
      max-width: 1050px;
      margin: 0 auto;
      display: flex;
      gap: 18px;
      align-items: center;
    }
    .brand__logo {
      height: clamp(48px, 7vw, 72px);
      width: auto;
      object-fit: contain;
    }
    .brand__titles {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .brand__title {
      margin: 0;
      font-size: clamp(30px, 4vw, 46px);
      color: var(--quiz-red);
      font-weight: 900;
      line-height: 1.1;
    }
    .brand__subtitle {
      color: var(--muted);
      margin: 0;
    }

    /* BUTTONS */
    .actions {
      max-width: 1050px;
      margin: 16px auto 8px;
      padding: 0 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: 2px solid transparent;
      font-size: 15px;
      cursor: pointer;
      transition: all 150ms;
      font-weight: 600;
    }
    .btn-primary { background: var(--spes-green); color: white; }
    .btn-secondary { background: white; border: 2px solid var(--light-green); color: var(--spes-green); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    #meta {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 8px 0 14px;
    }

    /* SCORE LIST */
    .wrap { max-width: 1050px; margin: 0 auto; padding: 0 20px 40px; }
    .grid { display: grid; gap: 14px; }

    .card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow:
        0 2px 2px rgba(0,0,0,0.03),
        0 5px 14px rgba(0,0,0,0.05);
    }

    .place {
      min-width: 48px;
      height: 48px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 20px;
      background: linear-gradient(135deg, var(--spes-yellow), #ffb300);
      color: #333;
    }
    .place.silver { background: linear-gradient(135deg, #e0e0e0, #bdbdbd); }
    .place.bronze { background: linear-gradient(135deg, #ffcc80, #fb8c00); }

    .team { flex: 1; font-weight: 700; font-size: 20px; }
    .team a { color: var(--text); text-decoration: none; }
    .team a:hover { text-decoration: underline; }

    .bar-wrap {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #efefef;
      overflow: hidden;
    }
    .bar {
      height: 100%;
      width: 0%;
      background: var(--spes-green);
      transition: width 0.5s ease;
    }

    .score {
      font-size: 22px;
      font-weight: 700;
      width: 60px;
      text-align: right;
      color: var(--text);
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="brand">
    <img src="assets/ouderraad-logo.png" class="brand__logo" alt="Ouderraad">
    <div class="brand__titles">
      <h1 class="brand__title">Quiz Nostra</h1>
      <p class="brand__subtitle">Live scorebord</p>
    </div>
  </div>
</header>

<div class="actions">
  <button id="btnAdd" class="btn btn-primary">+ Voeg team toe</button>
  <button id="btnUndo" class="btn btn-secondary">– Verwijder laatste team</button>
  <button id="btnAll" class="btn btn-secondary">Toon alle teams</button>
  <button id="btnReset" class="btn btn-secondary">Reset</button>
</div>

<div id="meta">Laden…</div>

<div class="wrap">
  <div id="list" class="grid"></div>
</div>

<script>
/* === CONFIG === */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";
const REFRESH_MS = 5000;

/* === STATE === */
let fullData = [];
let visibleCount = 0;

/* Helpers */
function roundNumberFromName(n){ const m = n.toLowerCase().match(/r(?:onde)?\s*(\d+)/); return m ? parseInt(m[1]) : null; }

async function fetchCSV(url){
  const res = await fetch(url + "&_t=" + Date.now(), {cache:"no-store"});
  return await res.text();
}

function parseCSV(text){
  const rows = text.trim().split(/\r?\n/)
      .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
      .map(x => x.replace(/^"|"$/g,"")));

  const headers = rows[0].map(h=>h.trim());
  const hLow = headers.map(h=>h.toLowerCase());

  const teamIdx = hLow.indexOf("team");
  const tokenIdx = hLow.indexOf("token");

  const roundCols = headers
    .map((h,i)=>({label:h,i,nr:roundNumberFromName(h)}))
    .filter(o=>o.nr!==null)
    .sort((a,b)=>a.nr-b.nr);

  return rows.slice(1).map(r=>{
    let total = 0;
    if(roundCols.length>0){
      for(const col of roundCols) total += Number(r[col.i]||0);
    }
    return {
      team: r[teamIdx]||"",
      token:r[tokenIdx]||"",
      total
    };
  }).filter(x=>x.team);
}

function computeRanks(list){
  list.sort((a,b)=>b.total - a.total || a.team.localeCompare(b.team));
  let prev=null, rank=0;
  list.forEach((x,i)=>{ if(prev===null||x.total<prev) rank=i+1; x.rank=rank; prev=x.total; });
  return list;
}

function render(list){
  const root = document.getElementById("list");
  root.innerHTML = "";

  const toShow = list.slice(-visibleCount);

  const max = Math.max(1,...toShow.map(x=>x.total));

  toShow.forEach(row=>{
    const card = document.createElement("div");
    card.className="card";

    const place = document.createElement("div");
    place.className="place";
    if(row.rank===2) place.classList.add("silver");
    if(row.rank===3) place.classList.add("bronze");
    place.textContent=row.rank;

    const team = document.createElement("div");
    team.className="team";
    const a=document.createElement("a");
    const q=row.token ? ("t="+encodeURIComponent(row.token)) : ("team="+encodeURIComponent(row.team));
    a.href="team.html?"+q;
    a.textContent=row.team;
    team.appendChild(a);

    const barWrap=document.createElement("div");
    barWrap.className="bar-wrap";
    const bar=document.createElement("div");
    bar.className="bar";
    bar.style.width=Math.round((row.total/max)*100)+"%";
    barWrap.appendChild(bar);

    const score=document.createElement("div");
    score.className="score";
    score.textContent=row.total;

    card.appendChild(place);
    card.appendChild(team);
    card.appendChild(barWrap);
    card.appendChild(score);

    root.appendChild(card);
  });

  const meta=document.getElementById("meta");
  meta.textContent = toShow.length ? 
      `Getoond: ${toShow.length}/${list.length} – Laatst bijgewerkt: ` + new Date().toLocaleTimeString()
      : "Laatst bijgewerkt: " + new Date().toLocaleTimeString();

  document.getElementById("btnAdd").disabled   = (visibleCount >= list.length);
  document.getElementById("btnUndo").disabled  = (visibleCount <= 0);
  document.getElementById("btnAll").disabled   = (visibleCount >= list.length);
  document.getElementById("btnReset").disabled = (visibleCount <= 0);
}

async function tick(){
  const csv = await fetchCSV(CSV_URL);
  const parsed = parseCSV(csv);
  fullData = computeRanks(parsed);

  if(visibleCount > fullData.length) visibleCount = fullData.length;

  render(fullData);
  setTimeout(tick, REFRESH_MS);
}

/* Controls */
document.getElementById("btnAdd").onclick = ()=>{ visibleCount++; render(fullData); };
document.getElementById("btnUndo").onclick = ()=>{ visibleCount=Math.max(0,visibleCount-1); render(fullData); };
document.getElementById("btnAll").onclick  = ()=>{ visibleCount=fullData.length; render(fullData); };
document.getElementById("btnReset").onclick= ()=>{ visibleCount=0; render(fullData); };

/* Start */
tick();
</script>
</body>
</html>