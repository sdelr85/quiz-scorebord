<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Nostra – Scorebord</title>

  <style>
    :root{
      /* Branding */
      --quiz-red:#E53935;
      --spes-green:#2E7D32;
      --spes-yellow:#FDD835;
      --light-green:#A5D6A7;

      /* UI */
      --bg:#f6f7f8;
      --card:#fff;
      --text:#222;
      --muted:#60666d;
      --line:#e1e2e5;

      /* Badges (niet‑podium) */
      --rank-default-bg:#CFE8CF;
      --rank-default-fg:#1B5E20;

      /* Podium border colors (to match fills) */
      --gold-border:#e0ac08;
      --silver-border:#aab0b6;
      --bronze-border:#c97a2b;
    }

    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    /* Header */
    .site-header{ background:#fff; border-bottom:4px solid var(--spes-green); padding:20px; }
    .brand{ max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:20px; }
    .brand__logo{ height:clamp(72px, 9vw, 110px); width:auto; object-fit:contain; }
    .brand__titles{ display:flex; flex-direction:column; gap:4px; }
    .brand__title{ margin:0; font-size:clamp(34px,4.4vw,50px); color:var(--quiz-red); font-weight:900; line-height:1.1; }
    .brand__subtitle{ margin:0; color:var(--muted); }

    /* Actions – green border, like bars */
    .actions{ max-width:1200px; margin:16px auto; padding:0 20px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn{
      padding:10px 16px; border-radius:10px;
      border:2px solid var(--spes-green);
      font-size:15px; font-weight:600; cursor:pointer; transition:.18s;
      background:#fff; color:var(--spes-green);
    }
    .btn-primary{ background:var(--spes-green); color:#fff; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    #meta{ text-align:center; color:var(--muted); font-size:13px; margin-top:-4px; margin-bottom:12px; }

    /* Lijst */
    .wrap{ max-width:1200px; margin:0 auto; padding:0 20px 60px; }
    .grid{ display:grid; gap:14px; }

    /* Eén kaart = één rank‑groep (kan meerdere teams bevatten) */
    .group-card{
      display:grid;
      grid-template-columns: 80px minmax(260px, 3.2fr) 2.2fr 90px; /* rank | namen | bar | score */
      align-items:center;
      gap:16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px 18px;
      box-shadow:0 2px 2px rgba(0,0,0,.03), 0 5px 14px rgba(0,0,0,.05);
    }

    /* Mobile responsive: stack layout on smaller screens */
    @media (max-width: 768px) {
      .group-card {
        grid-template-columns: auto 1fr; /* rank badge | content area */
        gap: 12px;
        align-items: start;
      }
      
      .place {
        grid-row: 1 / 3; /* span across team and bar rows */
        align-self: start;
      }
      
      .teamlist {
        grid-column: 2;
        grid-row: 1;
        margin-bottom: 8px;
      }
      
      .bar-wrap {
        grid-column: 2;
        grid-row: 2;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
      }
      
      .score {
        /* Score will be inside bar-wrap on mobile */
        text-align: right;
        font-size: 18px;
        font-weight: 900;
      }
    }

    @media (max-width: 480px) {
      .brand__title { font-size: 28px; }
      .score { font-size: 16px; }
      .place {
        width: 48px;
        height: 48px;
        font-size: 18px;
      }
      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    /* Rank badge – same size for all */
    .place {
      width:56px;
      height:56px;
      border-radius:12px;
      display:grid;
      place-items:center;
      font-weight:800;
      font-size:22px;
      box-sizing:border-box;

      /* DEFAULT (ranks ≥4): green box + green border */
      background: var(--rank-default-bg);     /* <- brings back the green fill */
      border: 2px solid #bfe0bf;              /* <- and its green border */
      color:#1B5E20;                           /* readable dark green text */
    }

    /* Podium: same size, but borders match the fills */
    .place.gold {
      background:linear-gradient(135deg, var(--spes-yellow), #ffb300);
      border:2px solid #d49800;
      color:#333;
    }
    .place.silver {
      background:linear-gradient(135deg, #e0e0e0, #bdbdbd);
      border:2px solid #9e9e9e;
      color:#333;
    }
    .place.bronze {
      background:linear-gradient(135deg, #ffcc80, #fb8c00);
      border:2px solid #c66a00;
      color:#333;
    }

    /* Teamlijst (meerdere namen onder elkaar) */
    .teamlist{ display:flex; flex-direction:column; gap:6px; }
    .team a{
      color:var(--text); text-decoration:none; font-weight:800;
      font-size:clamp(15px, 1.8vw, 20px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .team a:hover{ text-decoration:underline; }

    /* Bar: één per groep, geschaald tov totale max; groene outline */
    .bar-wrap{
      width:100%;
      height:14px;
      background:#efefef;
      border:2px solid var(--spes-green);
      border-radius:999px;
      overflow:hidden;
      box-sizing:border-box;
    }
    .bar{ height:100%; width:0%; background:var(--spes-green); transition:width .45s ease; }

    .score{
      text-align:right; font-size:24px; font-weight:900; color:var(--text);
      align-self:center;
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <img src="assets/ouderraad-logo.png" alt="Ouderraad Spes Nostra Kuurne" class="brand__logo">
    <div class="brand__titles">
      <h1 class="brand__title">Quiz Nostra</h1>
      <p class="brand__subtitle">Live scorebord</p>
    </div>
  </div>
</header>

<div class="actions">
  <button id="btnAdd"       class="btn btn-primary">+ Voeg team toe</button>
  <button id="btnAddTop5"   class="btn">+ Voeg top 5 team toe</button>
  <button id="btnUndo"      class="btn">– Verwijder laatste</button>
  <button id="btnAll"       class="btn">Toon alle teams</button>
  <button id="btnReset"     class="btn">Reset</button>
  <button id="btnRefresh"   class="btn">Vernieuwen</button>
</div>

<div id="meta">Nog geen teams getoond</div>

<div class="wrap"><div id="list" class="grid"></div></div>

<script>
/* === CONFIG === */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";

/* === STATE === */
let groups = [];              // [{rank, total, teams:[{team,token}]}]
let top5Groups = [];          // groups.filter(g=>g.rank<=5)
let visibleGroupCount = 0;    // incremental (from lowest rank up)
let visibleTop5Count = 0;     // incremental inside top‑5
let manualCleared = true;     // start empty
let maxTotal = 0;             // sum of maxima
let mode = "incremental";     // 'incremental' | 'top5inc' | 'all'
let modeLock = null;          // null | 'incremental' | 'top5inc'  (no mixing)

/* Helpers */
async function fetchCSV(u){
  const r = await fetch(u + "&_t=" + Date.now(), {cache:"no-store"});
  if(!r.ok) throw new Error("CSV ophalen mislukt");
  return await r.text();
}
function roundIndices(headers){
  const start = 2; // C
  let end = headers.length - 1;
  const last = headers.at(-1)?.trim().toLowerCase();
  if(last === "total" || last === "totaal") end = headers.length - 2;
  const idx=[]; for(let i=start;i<=end;i++) idx.push(i);
  return idx;
}
function parseCSV(text){
  const rows = text.trim().replace(/^\uFEFF/,"").split(/\r?\n/)
    .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x => x.replace(/^"|"$/g,"").trim()));
  if(!rows.length) return {teams:[], maxTotal:1};
  const headers = rows[0];
  const hLow = headers.map(h=>h.toLowerCase());
  const teamIdx = hLow.indexOf("team");
  const tokenIdx= hLow.indexOf("token");
  const rIdx = roundIndices(headers);

  // maxima: last row
  const maxRow = rows.at(-1) || [];
  const maxByRound = rIdx.map(i => Number((maxRow[i]||"0").replace(",","."))||0);
  const maxTotal = maxByRound.reduce((a,b)=>a+b,0) || 1;

  // team rows (exclude header and last)
  const trows = rows.slice(1, -1);
  const teams = trows.map(r=>{
    const team = (r[teamIdx]||"");
    const token= (r[tokenIdx]||"");
    const total = rIdx.reduce((acc,i)=> acc + (Number((r[i]||"0").replace(",","."))||0), 0);
    return {team, token, total};
  }).filter(x=>x.team);

  return {teams, maxTotal};
}
function denseRank(items){
  items.sort((a,b)=> b.total - a.total || a.team.localeCompare(b.team,'nl'));
  let prev=null, rank=0;
  items.forEach((x,i)=>{ if(prev===null || x.total<prev) rank=i+1; x.rank=rank; prev=x.total; });
  return items;
}
function groupByRank(items){
  const map = new Map();
  for(const t of items){
    if(!map.has(t.rank)) map.set(t.rank, {rank:t.rank, total:t.total, teams:[]});
    map.get(t.rank).teams.push({team:t.team, token:t.token});
  }
  for(const g of map.values()) g.teams.sort((a,b)=> a.team.localeCompare(b.team,'nl'));
  return Array.from(map.values()).sort((a,b)=> a.rank-b.rank);
}

function render(){
  const root = document.getElementById("list");
  const meta = document.getElementById("meta");
  root.innerHTML = "";

  if (manualCleared || !groups.length){
    meta.textContent = "Nog geen teams getoond";
    updateButtons();
    return;
  }

  let visible = [];
  if(mode === "all"){
    visible = groups;
  }else if(mode === "top5inc"){
    const take = Math.max(0, Math.min(visibleTop5Count, top5Groups.length));
    visible = top5Groups.slice(-take);              // from rank 5 upwards
  }else{
    const take = Math.max(0, Math.min(visibleGroupCount, groups.length));
    visible = groups.slice(-take);                  // from lowest upwards
  }

  const denom = Math.max(1, maxTotal);
  for(const g of visible){
    const card = document.createElement("div");
    card.className = "group-card";

    const badge = document.createElement("div");
    badge.className = "place";
    if(g.rank===1) badge.classList.add("gold");
    else if(g.rank===2) badge.classList.add("silver");
    else if(g.rank===3) badge.classList.add("bronze");
    badge.textContent = g.rank;

    const list = document.createElement("div");
    list.className = "teamlist";
    g.teams.forEach(t=>{
      const div=document.createElement("div");
      div.className="team";
      const a=document.createElement("a");
      const q = t.token ? ("t="+encodeURIComponent(t.token)) : ("team="+encodeURIComponent(t.team));
      a.href = "team.html?"+q;
      a.textContent = t.team;
      div.appendChild(a);
      list.appendChild(div);
    });

    const barWrap = document.createElement("div");
    barWrap.className = "bar-wrap";
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = Math.round((g.total/denom)*100) + "%";
    barWrap.appendChild(bar);

    const score = document.createElement("div");
    score.className = "score";
    score.textContent = g.total;

    card.appendChild(badge);
    card.appendChild(list);
    card.appendChild(barWrap);
    card.appendChild(score);
    
    root.appendChild(card);
  }

  const shownRanks = visible.length;
  const shownTeams = visible.reduce((sum, g) => sum + g.teams.length, 0);
  const totalTeams = groups.reduce((sum, g) => sum + g.teams.length, 0);
  meta.textContent = (shownRanks ? `Getoonde rangen: ${shownRanks}/${groups.length} - Getoonde teams: ${shownTeams}/${totalTeams} – ` : "Nog geen teams getoond – ")
                   + "Laatst bijgewerkt: " + new Date().toLocaleTimeString();
  updateButtons();
}

function updateButtons(){
  const add    = document.getElementById("btnAdd");
  const addTop = document.getElementById("btnAddTop5");
  const undo   = document.getElementById("btnUndo");
  const all    = document.getElementById("btnAll");
  const rst    = document.getElementById("btnReset");
  const ref    = document.getElementById("btnRefresh");

  // Lock‑regels (geen mixing tussen “voeg”‑modi)
  add.disabled    = (modeLock === 'top5inc');
  addTop.disabled = (modeLock === 'incremental');

  if (manualCleared){
    undo.disabled=true; all.disabled=false; rst.disabled=false; ref.disabled=false;
  } else if (mode === "all"){
    undo.disabled=false; all.disabled=true;  rst.disabled=false; ref.disabled=false;
  } else if (mode === "top5inc"){
    undo.disabled = (visibleTop5Count<=0);
  } else {
    undo.disabled = (visibleGroupCount<=0);
  }
}

/* ---- Handlers ---- */
async function refresh(preserve=true){
  const csv = await fetchCSV(CSV_URL);
  const parsed = parseCSV(csv);
  maxTotal = parsed.maxTotal || 1;

  const ranked = denseRank(parsed.teams);
  groups = groupByRank(ranked);
  top5Groups = groups.filter(g => g.rank <= 5);

  if(preserve){
    visibleGroupCount  = Math.max(0, Math.min(visibleGroupCount,  groups.length));
    visibleTop5Count   = Math.max(0, Math.min(visibleTop5Count,   top5Groups.length));
  }else{
    manualCleared = true; mode="incremental"; modeLock=null; visibleGroupCount=0; visibleTop5Count=0;
  }
  render();
}

document.getElementById("btnAdd").onclick = ()=>{
  if(modeLock && modeLock!=='incremental'){ alert("Reset eerst om van modus te wisselen."); return; }
  modeLock='incremental';
  manualCleared=false; mode="incremental";
  visibleGroupCount = Math.min(visibleGroupCount+1, groups.length);
  render();
};

document.getElementById("btnAddTop5").onclick = ()=>{
  if(modeLock && modeLock!=='top5inc'){ alert("Reset eerst om van modus te wisselen."); return; }
  modeLock='top5inc';
  manualCleared=false; mode="top5inc";
  visibleTop5Count = Math.min(visibleTop5Count+1, top5Groups.length);
  render();
};

document.getElementById("btnUndo").onclick = ()=>{
  if (manualCleared) return;
  if (mode === "top5inc"){
    visibleTop5Count = Math.max(visibleTop5Count-1, 0);
    if(visibleTop5Count===0) manualCleared=true;
  } else if (mode === "incremental"){
    visibleGroupCount = Math.max(visibleGroupCount-1, 0);
    if(visibleGroupCount===0) manualCleared=true;
  } else {
    // vanuit "all": stap terug naar de actieve lock (indien aanwezig)
    if(modeLock==='top5inc'){ mode='top5inc'; visibleTop5Count = Math.max(top5Groups.length-1,0); }
    else { mode='incremental'; visibleGroupCount = Math.max(groups.length-1,0); }
  }
  render();
};

document.getElementById("btnAll").onclick  = ()=>{ manualCleared=false; mode="all"; render(); };
document.getElementById("btnReset").onclick= ()=>{ manualCleared=true; mode="incremental"; modeLock=null; visibleGroupCount=0; visibleTop5Count=0; render(); };
document.getElementById("btnRefresh").onclick = ()=>{ refresh(true); };

/* Start: laad data, maar toon niets tot gebruiker kiest */
refresh(true).catch(console.error);
</script>
</body>
</html>