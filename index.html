<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Nostra – Scorebord</title>

<style>
  :root {
    /* Branding colors */
    --quiz-red: #E53935;
    --spes-green: #2E7D32;
    --spes-green-dark: #1B5E20;
    --spes-yellow: #FDD835;
    --light-green: #A5D6A7;

    /* UI */
    --bg: #f6f7f8;
    --card: #ffffff;
    --text: #222;
    --muted: #60666d;
    --line: #e1e2e5;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }

  /* Header */
  .site-header {
    background: white;
    border-bottom: 4px solid var(--spes-green);
    padding: 18px 20px;
  }

  .brand {
    max-width: 1050px;
    margin: 0 auto;
    display: flex;
    gap: 18px;
    align-items: center;
  }

  .brand__logo {
    height: clamp(36px, 6vw, 60px);
    width: auto;
    object-fit: contain;
  }

  .brand__titles {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .brand__title {
    margin: 0;
    font-size: clamp(28px, 4vw, 44px);
    color: var(--quiz-red);
    font-weight: 900;
    line-height: 1.1;
  }

  .brand__subtitle {
    color: var(--muted);
    margin: 0;
  }

  /* Buttons */
  .actions {
    max-width: 1050px;
    margin: 20px auto;
    padding: 0 20px;
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .btn {
    padding: 10px 18px;
    border-radius: 10px;
    border: 2px solid transparent;
    font-size: 16px;
    cursor: pointer;
    transition: all 150ms;
    font-weight: 600;
  }

  .btn-primary {
    background: var(--spes-green);
    color: white;
  }

  .btn-secondary {
    background: white;
    border: 2px solid var(--light-green);
    color: var(--spes-green);
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Status text */
  #meta {
    text-align: center;
    color: var(--muted);
    font-size: 13px;
    margin-bottom: 14px;
  }

  /* Scoreboard list */
  .wrap {
    max-width: 1050px;
    margin: 0 auto;
    padding: 0 20px 40px;
  }

  .grid {
    display: grid;
    gap: 14px;
  }

  .card {
    display: flex;
    align-items: center;
    gap: 14px;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow:
      0 2px 2px rgba(0,0,0,0.03),
      0 5px 14px rgba(0,0,0,0.05);
  }

  /* Rank badges */
  .place {
    min-width: 48px;
    height: 48px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    font-weight: 800;
    font-size: 20px;
    background: linear-gradient(135deg, var(--spes-yellow), #ffb300);
    color: #333;
  }
  .place.silver {
    background: linear-gradient(135deg, #e0e0e0, #bdbdbd);
  }
  .place.bronze {
    background: linear-gradient(135deg, #ffcc80, #fb8c00);
  }

  /* Team name / link */
  .team {
    flex: 1;
    font-weight: 700;
    font-size: 20px;
  }

  .team a {
    color: var(--text);
    text-decoration: none;
  }
  .team a:hover {
    text-decoration: underline;
  }

  /* Progress bars */
  .bar-wrap {
    width: 100%;
    height: 8px;
    border-radius: 999px;
    background: #efefef;
    overflow: hidden;
  }

  .bar {
    height: 100%;
    width: 0%;
    background: var(--spes-green);
    transition: width 0.5s ease;
  }

  .score {
    font-size: 22px;
    font-weight: 700;
    width: 60px;
    text-align: right;
    color: var(--text);
  }

</style>
</head>

<body>

<header class="site-header">
  <div class="brand">
    <img src="assets/ouderraad-logo.png"
     alt="Ouderraad Spes Nostra Kuurne"
     class="brand__logo">Quiz Nostra</h1>
      <p class="brand__subtitle">Live Scorebord</p>
    </div>
  </div>
</header>

<div id="meta">Laden…</div>

<div class="wrap">
  <div id="list" class="grid"></div>
</div>

<script>
/* === CONFIG === */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";
const REFRESH_MS = 5000;

/* === Helpers === */
function roundNumberFromName(name) {
  const m = String(name).toLowerCase().match(/r(?:onde)?\s*(\d+)/i);
  return m ? parseInt(m[1], 10) : null;
}

async function fetchCSV(url) {
  const res = await fetch(url + "&_t=" + Date.now(), { cache: "no-store" });
  return await res.text();
}

function parseCSV(text) {
  const rows = text.trim()
    .replace(/^\uFEFF/, "")
    .split(/\r?\n/)
    .map(r => r.split(",").map(x => x.replace(/^"|"$/g, "").trim()));

  const headers = rows[0].map(h => h.trim());
  const hLow = headers.map(h => h.toLowerCase());

  const teamIdx = hLow.indexOf("team");
  const tokenIdx = hLow.indexOf("token");

  const roundCols = headers
    .map((h,i) => ({ label: h, i, nr: roundNumberFromName(h) }))
    .filter(o => o.nr !== null)
    .sort((a,b) => a.nr - b.nr);

  const data = rows.slice(1).map(r => {
    const team = r[teamIdx] || "";
    const token = r[tokenIdx] || "";
    let total = 0;

    if (roundCols.length > 0) {
      for (const col of roundCols) {
        total += Number(r[col.i] || 0);
      }
    }

    return { team, token, total };
  });

  return data.filter(x => x.team);
}

function computeRanks(list) {
  list.sort((a,b) => b.total - a.total || a.team.localeCompare(b.team));
  let prev = null, rank = 0;
  list.forEach((x,i) => {
    if (prev === null || x.total < prev) rank = i + 1;
    x.rank = rank;
    prev = x.total;
  });
  return list;
}

function render(list) {
  const root = document.getElementById("list");
  root.innerHTML = "";

  const max = Math.max(1, ...list.map(x => x.total));

  list.forEach(row => {
    const card = document.createElement("div");
    card.className = "card";

    const place = document.createElement("div");
    place.className = "place";
    if(row.rank === 2) place.classList.add("silver");
    if(row.rank === 3) place.classList.add("bronze");
    place.textContent = row.rank;

    const name = document.createElement("div");
    name.className = "team";
    name.innerHTML = `<a href="team.html?team=${encodeURIComponent(row.team)}m}</a>`;

    const barWrap = document.createElement("div");
    barWrap.className = "bar-wrap";
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = Math.round((row.total / max) * 100) + "%";
    barWrap.appendChild(bar);

    const score = document.createElement("div");
    score.className = "score";
    score.textContent = row.total;

    card.appendChild(place);
    card.appendChild(name);
    card.appendChild(barWrap);
    card.appendChild(score);

    root.appendChild(card);
  });

  document.getElementById("meta").textContent =
    "Laatst bijgewerkt: " + new Date().toLocaleTimeString();
}

async function tick() {
  try {
    const csv = await fetchCSV(CSV_URL);
    const data = parseCSV(csv);
    const ranked = computeRanks(data);
    render(ranked);
  } catch (e) {
    console.error(e);
  } finally {
    setTimeout(tick, REFRESH_MS);
  }
}

tick();
</script>

</body>
</html>