<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Nostra – Scorebord</title>

  <style>
    :root{
      /* Branding */
      --quiz-red:#E53935;
      --spes-green:#2E7D32;
      --spes-yellow:#FDD835;
      --light-green:#A5D6A7;

      /* UI */
      --bg:#f6f7f8;
      --card:#fff;
      --text:#222;
      --muted:#60666d;
      --line:#e1e2e5;

      /* Badges (niet‑podium) */
      --rank-default-bg:#CFE8CF;
      --rank-default-fg:#1B5E20;
    }

    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    /* Header */
    .site-header{ background:#fff; border-bottom:4px solid var(--spes-green); padding:20px; }
    .brand{ max-width:1050px; margin:0 auto; display:flex; align-items:center; gap:20px; }
    .brand__logo{ height:clamp(72px, 9vw, 110px); width:auto; object-fit:contain; }
    .brand__titles{ display:flex; flex-direction:column; gap:4px; }
    .brand__title{ margin:0; font-size:clamp(34px,4.4vw,50px); color:var(--quiz-red); font-weight:900; line-height:1.1; }
    .brand__subtitle{ margin:0; color:var(--muted); }

    /* Actions */
    .actions{ max-width:1050px; margin:16px auto; padding:0 20px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn{ padding:10px 16px; border-radius:10px; border:2px solid transparent; font-size:15px; font-weight:600; cursor:pointer; transition:.18s; }
    .btn-primary{ background:var(--spes-green); color:#fff; }
    .btn-secondary{ background:#fff; border:2px solid var(--light-green); color:var(--spes-green); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    #meta{ text-align:center; color:var(--muted); font-size:13px; margin-top:-4px; margin-bottom:12px; }

    /* Lijst */
    .wrap{ max-width:1050px; margin:0 auto; padding:0 20px 40px; }
    .grid{ display:grid; gap:14px; }

    /* Kaart in kolommen: [ rank | team | balk | score ]  */
    .card{
      display:grid;
      grid-template-columns: 72px minmax(260px, 3.2fr) 2.2fr 72px; /* teamnaam ruimer, balk korter */
      align-items:center;
      gap:14px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 16px;
      box-shadow:0 2px 2px rgba(0,0,0,.03), 0 5px 14px rgba(0,0,0,.05);
    }

    /* Rang-badge */
    .place{
      width:52px; height:52px; border-radius:12px;
      display:grid; place-items:center;
      font-weight:800; font-size:20px;
      color:var(--rank-default-fg);
      background:var(--rank-default-bg);
      border:2px solid #bfe0bf;
      justify-self:center;
    }
    .place.gold  { background:linear-gradient(135deg, var(--spes-yellow), #ffb300); color:#333; border:none; }
    .place.silver{ background:linear-gradient(135deg, #e0e0e0, #bdbdbd); color:#333; border:none; }
    .place.bronze{ background:linear-gradient(135deg, #ffcc80, #fb8c00); color:#333; border:none; }

    /* Teamnaam – enkel-lijn + ellipsis */
    .team{
      font-weight:800;
      font-size:clamp(15px, 1.8vw, 20px);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .team a{ color:var(--text); text-decoration:none; }
    .team a:hover{ text-decoration:underline; }

    .bar-wrap{ width:100%; height:10px; background:#efefef; border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:var(--spes-green); transition:width .45s ease; }

    .score{ text-align:right; font-size:22px; font-weight:800; color:var(--text); }
  </style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <img src="assets/ouderraad-logo.png" alt="Ouderraad Spes Nostra Kuurne" class="brand__logo">
    <div class="brand__titles">
      <h1 class="brand__title">Quiz Nostra</h1>
      <p class="brand__subtitle">Live scorebord</p>
    </div>
  </div>
</header>

<div class="actions">
  <button id="btnAdd"     class="btn btn-primary">+ Voeg team toe</button>
  <button id="btnUndo"    class="btn btn-secondary">– Verwijder laatste</button>
  <button id="btnAll"     class="btn btn-secondary">Toon alle teams</button>
  <button id="btnReset"   class="btn btn-secondary">Reset</button>
  <button id="btnRefresh" class="btn btn-secondary">Vernieuwen</button>
</div>

<div id="meta">Nog geen teams getoond</div>

<div class="wrap"><div id="list" class="grid"></div></div>

<script>
/* === CONFIG === */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";

/* === STATE === */
let fullData = [];
let visibleCount = 0;
/* Start leeg: gebruiker kiest Add/All of klikt Vernieuwen en dan Add/All */
let manualCleared = true;

/* Helpers */
async function fetchCSV(u){
  const r = await fetch(u + "&_t=" + Date.now(), {cache:"no-store"});
  if(!r.ok) throw new Error("CSV ophalen mislukt");
  return await r.text();
}

/* Column C..(last-1 if 'TOTAL'): detect round columns from headers */
function getRoundColumnIndices(headers){
  const start = 2; // column C (0=A,1=B,2=C)
  let end = headers.length - 1;
  const lastLabel = headers[headers.length-1]?.trim().toLowerCase();
  if (lastLabel === "total" || lastLabel === "totaal") end = headers.length - 2;
  // generate indices from start..end inclusive
  const idxs = [];
  for(let i=start;i<=end;i++) idxs.push(i);
  return idxs;
}

function parseCSV(text){
  const rows = text.trim().replace(/^\uFEFF/,"").split(/\r?\n/)
    .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x => x.replace(/^"|"$/g,"").trim()));
  if(!rows.length) return [];

  const headers = rows[0].map(h=>h.trim());
  const hLow = headers.map(h=>h.toLowerCase());
  const teamIdx  = hLow.indexOf("team");
  const tokenIdx = hLow.indexOf("token");

  const roundIdxs = getRoundColumnIndices(headers);

  const data = rows.slice(1).map(r=>{
    const team  = teamIdx>=0 ? (r[teamIdx]||"") : "";
    const token = tokenIdx>=0 ? (r[tokenIdx]||"") : "";
    let total=0;
    for(const i of roundIdxs){
      total += Number((r[i]||"0").replace(",",".")) || 0;
    }
    return {team, token, total};
  }).filter(x=>x.team);

  return data;
}

function computeRanks(list){
  list.sort((a,b)=> b.total - a.total || a.team.localeCompare(b.team,'nl'));
  let prev=null, rank=0;
  list.forEach((x,i)=>{ if(prev===null||x.total<prev) rank=i+1; x.rank=rank; prev=x.total; });
  return list;
}

function render(list){
  const root = document.getElementById("list");
  const meta = document.getElementById("meta");
  root.innerHTML = "";

  if (manualCleared) {
    meta.textContent = "Nog geen teams getoond";
    updateButtons();
    return;
  }

  const toShow = list.slice(-visibleCount);
  const max = Math.max(1, ...toShow.map(x=>x.total));

  toShow.forEach(row=>{
    const card = document.createElement("div");
    card.className = "card";

    const place = document.createElement("div");
    place.className = "place";
    if(row.rank===1) place.classList.add("gold");
    else if(row.rank===2) place.classList.add("silver");
    else if(row.rank===3) place.classList.add("bronze");
    place.textContent = row.rank;

    const team = document.createElement("div");
    team.className = "team";
    const a = document.createElement("a");
    const q = row.token ? ("t="+encodeURIComponent(row.token)) : ("team="+encodeURIComponent(row.team));
    a.href = "team.html?"+q;
    a.textContent = row.team;
    team.appendChild(a);

    const barWrap = document.createElement("div");
    barWrap.className = "bar-wrap";
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = Math.round((row.total / max) * 100) + "%";
    barWrap.appendChild(bar);

    const score = document.createElement("div");
    score.className = "score";
    score.textContent = row.total;

    card.appendChild(place);
    card.appendChild(team);
    card.appendChild(barWrap);
    card.appendChild(score);
    root.appendChild(card);
  });

  meta.textContent = (toShow.length ? `Getoond: ${toShow.length}/${list.length} – ` : "Nog geen teams getoond – ")
                   + "Laatst bijgewerkt: " + new Date().toLocaleTimeString();

  updateButtons();
}

function updateButtons(){
  const add = document.getElementById("btnAdd");
  const undo= document.getElementById("btnUndo");
  const all = document.getElementById("btnAll");
  const rst = document.getElementById("btnReset");
  const ref = document.getElementById("btnRefresh");
  if (manualCleared){
    add.disabled=false; all.disabled=false; undo.disabled=true; rst.disabled=false; ref.disabled=false;
  } else {
    add.disabled   = visibleCount >= fullData.length;
    undo.disabled  = visibleCount <= 0;
    all.disabled   = visibleCount >= fullData.length;
    rst.disabled   = false;
    ref.disabled   = false;
  }
}

/* ---- Handlers ---- */
async function refresh(preserveState=true){
  const csv = await fetchCSV(CSV_URL);
  fullData = computeRanks(parseCSV(csv));
  if (preserveState) {
    if (visibleCount > fullData.length) visibleCount = fullData.length;
    render(fullData);
  } else {
    manualCleared = true; visibleCount = 0; render(fullData);
  }
}

document.getElementById("btnAdd").onclick  = ()=>{ manualCleared=false; visibleCount = Math.min(visibleCount+1, fullData.length); render(fullData); };
document.getElementById("btnUndo").onclick = ()=>{ if (manualCleared) return; visibleCount = Math.max(visibleCount-1, 0); render(fullData); };
document.getElementById("btnAll").onclick  = ()=>{ manualCleared=false; visibleCount = fullData.length; render(fullData); };
document.getElementById("btnReset").onclick= ()=>{ manualCleared=true; visibleCount=0; render(fullData); };
document.getElementById("btnRefresh").onclick = ()=>{ refresh(true); };

/* Start: éénmalig data laden, maar NIETS tonen zolang manualCleared=true */
refresh(true).catch(console.error);  // haalt CSV op; render() toont “Nog geen teams getoond”
</script>
</body>
</html>