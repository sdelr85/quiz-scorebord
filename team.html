<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Nostra – Teamdetail</title>

  <style>
    :root{
      --quiz-red:#E53935;
      --spes-green:#2E7D32;
      --spes-yellow:#FDD835;
      --light-green:#A5D6A7;

      --bg:#f6f7f8;
      --card:#fff;
      --text:#222;
      --muted:#60666d;
      --line:#e1e2e5;

      --rank-default-bg:#CFE8CF;
      --rank-default-fg:#1B5E20;
    }

    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    /* Header */
    .site-header{ background:#fff; border-bottom:4px solid var(--spes-green); padding:20px; margin-bottom:18px; }
    .brand{ max-width:1050px; margin:0 auto; display:flex; align-items:center; gap:20px; }
    .brand__logo{ height:clamp(72px, 9vw, 110px); width:auto; object-fit:contain; }
    .brand__titles{ display:flex; flex-direction:column; gap:4px; }
    .brand__title{ margin:0; font-size:clamp(34px,4.4vw,50px); color:var(--quiz-red); font-weight:900; line-height:1.1; }
    .brand__subtitle{ margin:0; color:var(--muted); }

    .wrap{ max-width:1050px; margin:0 auto; padding:0 20px 36px; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 2px rgba(0,0,0,.03), 0 5px 14px rgba(0,0,0,.05);
      margin-bottom:16px;
    }

    .pill{ display:inline-block; padding:4px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:13px; margin-bottom:12px; }

    /* Ronde-lijst (zonder balken) — met rondebadge */
    .rows{ display:grid; gap:10px; }
    .row{
      display:grid; grid-template-columns: minmax(260px, 1fr) auto;
      gap:12px; align-items:center; padding:6px 0; border-bottom:1px dashed var(--line);
    }
    .row:last-child{ border-bottom:none; }

    .label{
      display:flex; align-items:center; gap:10px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-weight:700;
    }
    .rnum{
      min-width:36px; height:36px; border-radius:10px;
      display:grid; place-items:center;
      font-weight:800; color:var(--rank-default-fg);
      background:var(--rank-default-bg);
      border:2px solid #bfe0bf;
      font-size:16px;
      flex:0 0 auto;
    }
    .value{ text-align:right; font-weight:800; }

    .back{ margin-top:18px; }
    .back a{ color:var(--spes-green); text-decoration:none; font-weight:700; }
    .back a:hover{ text-decoration:underline; }

    /* Grafiek – hoger + betere marges + schuine labels */
    .chart{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 2px rgba(0,0,0,.03), 0 5px 14px rgba(0,0,0,.05);
    }
    .chart h3{ margin:0 0 8px; font-size:18px; }
    .chart svg{ width:100%; height:520px; display:block; } /* hoger */
    .axis text{ fill:#666; font-size:12px; }
    .gridline{ stroke:#e9eaec; stroke-width:1; }
    .rank-path{ fill:none; stroke:var(--spes-green); stroke-width:3; }
    .rank-dot{ fill:var(--spes-green); stroke:#fff; stroke-width:1.5; cursor:pointer; }
  </style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <img src="assets/ouderraad-logo.png" alt="Ouderraad Spes Nostra Kuurne" class="brand__logo">
    <div class="brand__titles">
      <h1 class="brand__title" id="teamTitle">Team</h1>
      <p class="brand__subtitle">Detailoverzicht</p>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div id="rankInfo" class="pill">Positie: -</div>
    <div class="rows" id="roundList"></div>
    <div style="display:flex; justify-content:space-between; margin-top:12px; font-weight:800;">
      <span>Totaal</span><span id="totalScore">0</span>
    </div>
  </div>

  <div class="chart">
    <h3>Evolutie van de positie per ronde</h3>
    <svg id="rankChart" viewBox="0 0 980 520" preserveAspectRatio="none" aria-label="Positie per ronde"></svg>
  </div>

  <p class="back">
    <a href="index.html" onclick="if(document.referrer){history.back(); return false;}">← Terug naar scorebord</a>
  </p>
</div>

<script>
/*** CONFIG ***/
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";

/*** Helpers ***/
const norm = s => String(s||"").normalize('NFKC').trim().toLowerCase().replace(/\s+/g,' ');
async function fetchCSV(u){ const r = await fetch(u + "&_t=" + Date.now(), {cache:"no-store"}); if(!r.ok) throw new Error("CSV ophalen mislukt"); return await r.text(); }

/* Rondekolommen: vanaf C, laatste "TOTAL/TOTAAL" negeren; laatste rij = maxima */
function getRoundColumns(headers){
  const start = 2; // C
  let end = headers.length - 1;
  const lastLabel = headers[headers.length-1]?.trim().toLowerCase();
  if (lastLabel === "total" || lastLabel === "totaal") end = headers.length - 2;
  const cols = [];
  for(let i=start;i<=end;i++) cols.push({label:headers[i], i});
  return cols;
}

function parseCSV(text){
  const rows = text.trim().replace(/^\uFEFF/,"").split(/\r?\n/)
    .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x => x.replace(/^"|"$/g,"").trim()));
  if(!rows.length) return {data:[], roundCols:[], maxByRound:[]};

  const headers = rows[0].map(h=>h.trim());
  const hLow    = headers.map(h=>h.toLowerCase());
  const teamIdx  = hLow.indexOf("team");
  const tokenIdx = hLow.indexOf("token");

  const roundCols = getRoundColumns(headers);

  // maxima = laatste rij
  const last = rows[rows.length-1] || [];
  const maxByRound = roundCols.map(c => Number((last[c.i]||"0").replace(",","."))||0);

  // teams = rijen 1..(n-2): data zonder maxima
  const teamRows = rows.slice(1, Math.max(1, rows.length-1));
  const data = teamRows.map(r=>{
    const team  = (r[teamIdx]  || "");
    const token = (r[tokenIdx] || "");
    const rounds = roundCols.map(c => Number((r[c.i]||"0").replace(",","."))||0);
    const total  = rounds.reduce((a,b)=>a+b,0);
    return {team, token, rounds, total};
  }).filter(x=>x.team);

  return {data, roundCols, maxByRound};
}

/*** Ranking helpers ***/
function denseRanks(items){
  const sorted=[...items].sort((a,b)=>b.total-a.total||a.team.localeCompare(b.team,'nl'));
  let prev=null, rank=0; const map=new Map();
  sorted.forEach((x,i)=>{ if(prev===null||x.total<prev) rank=i+1; map.set(x.team,rank); prev=x.total; });
  return map;
}
/* Positie per ronde (cumulatief) */
function positionsPerRound(ds){
  const {data, roundCols} = ds;
  const R = roundCols.length;
  const cum = data.map(d => ({
    team:d.team,
    cum: d.rounds.reduce((acc,v,i)=>{ acc[i]=(i?acc[i-1]:0)+v; return acc; }, Array(R).fill(0))
  }));
  const pos = new Map(); data.forEach(d=>pos.set(d.team, Array(R).fill(null)));
  for(let r=0; r<R; r++){
    const totals = cum.map(x => ({team:x.team, total:x.cum[r]}));
    const ranks  = denseRanks(totals);
    totals.forEach(x => pos.get(x.team)[r] = ranks.get(x.team));
  }
  return pos;
}

/*** Render ***/
function renderTeam(ds, keyRaw){
  const k = norm(keyRaw);
  const item = ds.data.find(x => norm(x.token)===k) || ds.data.find(x => norm(x.team)===k);

  const title   = document.getElementById("teamTitle");
  const roundsEl= document.getElementById("roundList");
  const totalEl = document.getElementById("totalScore");
  const rankInfo= document.getElementById("rankInfo");

  if(!item){ title.textContent="Team niet gevonden"; roundsEl.innerHTML="<p>Niet gevonden.</p>"; return; }

  title.textContent = item.team;

  const endRank = denseRanks(ds.data.map(d => ({team:d.team,total:d.total}))).get(item.team) || "-";
  rankInfo.textContent = `Positie: ${endRank} / ${ds.data.length}`;

  /* Tabel met rondebadge + "(i). label" en "score / max" */
  roundsEl.innerHTML="";
  const names = ds.roundCols.map((c,i)=> `${i+1}. ${c.label||("R"+(i+1))}`);
  item.rounds.forEach((v,i)=>{
    const maxR = ds.maxByRound[i] ?? 0;

    const row=document.createElement("div"); row.className="row";

    const label=document.createElement("div"); label.className="label";
    const badge=document.createElement("div"); badge.className="rnum"; badge.textContent = (i+1);
    const text=document.createElement("div"); text.textContent = names[i];
    label.appendChild(badge); label.appendChild(text);

    const value=document.createElement("div"); value.className="value"; value.textContent = `${v} / ${maxR}`;

    row.appendChild(label); row.appendChild(value);
    roundsEl.appendChild(row);
  });
  totalEl.textContent = item.total;

  /* Grafiek */
  const posMap = positionsPerRound(ds);
  drawRankChart("rankChart", posMap.get(item.team), ds.data.length, ds.roundCols.map(c=>c.label||""));
}

/* SVG grafiek: x=rondenamen (gekanteld), y=1..N (1 bovenaan), hover tooltips */
function drawRankChart(svgId, posArr, nTeams, labels){
  const svg = document.getElementById(svgId);
  svg.innerHTML = "";
  if(!posArr || !posArr.length){ svg.innerHTML = "<text x='12' y='24' class='axis'>Geen data</text>"; return; }

  const W=980, H=520, L=70, R=18, T=14, B=80;  // royale marges
  const plotW=W-L-R, plotH=H-T-B;

  const x = (i)=> L + (posArr.length<=1? plotW/2 : (i*(plotW/(posArr.length-1))));
  const y = (rank)=> T + ((rank-1) * (plotH/Math.max(1,(nTeams-1)))); // 1 bovenaan

  /* grid + y-labels (we labelen elke rank t/m 50; daarboven label elke 2/5) */
  const labelStep = (nTeams<=50) ? 1 : (nTeams<=100 ? 2 : 5);
  for(let r=1; r<=nTeams; r++){
    const yy=y(r);
    const gl = document.createElementNS("http://www.w3.org/2000/svg","line");
    gl.setAttribute("x1", L); gl.setAttribute("y1", yy);
    gl.setAttribute("x2", W-R); gl.setAttribute("y2", yy);
    gl.setAttribute("class","gridline");
    svg.appendChild(gl);

    if((r-1)%labelStep===0){
      const lt = document.createElementNS("http://www.w3.org/2000/svg","text");
      lt.setAttribute("x", L-8); lt.setAttribute("y", yy+4);
      lt.setAttribute("text-anchor","end");
      lt.setAttribute("class","axis");
      lt.textContent = r;
      svg.appendChild(lt);
    }
  }

  /* x‑as labels met hoek (-45°) */
  labels.forEach((lab,i)=>{
    const tx = document.createElementNS("http://www.w3.org/2000/svg","text");
    const xi = x(i), yi = H-8;
    tx.setAttribute("x", xi);
    tx.setAttribute("y", yi);
    tx.setAttribute("class","axis");
    tx.setAttribute("text-anchor","end");
    tx.setAttribute("transform", `rotate(-45, ${xi}, ${yi})`);
    tx.textContent = lab || `R${i+1}`;
    svg.appendChild(tx);
  });

  /* lijnpad */
  let d=""; posArr.forEach((rank,i)=>{ const xi=x(i), yi=y(rank); d += (i===0? `M ${xi} ${yi}` : ` L ${xi} ${yi}`); });
  const path = document.createElementNS("http://www.w3.org/2000/svg","path");
  path.setAttribute("class","rank-path"); path.setAttribute("d", d); svg.appendChild(path);

  /* punten + browser tooltip via <title> */
  posArr.forEach((rank,i)=>{
    const ci = document.createElementNS("http://www.w3.org/2000/svg","circle");
    ci.setAttribute("class","rank-dot");
    ci.setAttribute("cx", x(i)); ci.setAttribute("cy", y(rank)); ci.setAttribute("r","5");
    const t = document.createElementNS("http://www.w3.org/2000/svg","title");
    t.textContent = `${labels[i]||("R"+(i+1))}: positie ${rank}`;
    ci.appendChild(t);
    svg.appendChild(ci);
  });
}

/*** Init ***/
(async function(){
  const p   = new URLSearchParams(location.search);
  const key = (p.get("t") || p.get("team") || "").trim();
  if(!key){ document.getElementById("teamTitle").textContent="Geen team geselecteerd"; return; }

  try{
    const csv = await fetchCSV(CSV_URL);
    const ds  = parseCSV(csv);
    renderTeam(ds, key);
  }catch(e){
    document.getElementById("teamTitle").textContent="Fout bij laden";
    console.error(e);
  }
})();
</script>
</body>
</html>