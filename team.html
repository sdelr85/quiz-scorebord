<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teamdetail</title>
  <style>
    body { margin:0; background:#0f1226; color:#e8ecff; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { max-width:900px; margin:0 auto; padding:24px 16px 40px; }
    h1 { margin:0 0 6px; font-size:clamp(22px,3.4vw,36px); }
    .muted { color:#9aa3c7; }
    .card { background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:16px; margin-top:16px; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.08);}
    .row:last-child { border-bottom:none; }
    .bar-wrap{ height:8px; background:rgba(255,255,255,0.07); border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:#6c8cff; transition:width .4s ease; }
    .pill{ display:inline-block; padding:4px 10px; border:1px solid rgba(255,255,255,0.18); border-radius:999px; color:#9aa3c7; font-size:13px; }
    a { color:#9bb5ff; }
  </style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Team</h1>
  <div class="muted" id="subtitle">Rondes & totaalscore</div>

  <div class="card">
    <div class="pill" id="rankInfo">Positie: -</div>
    <div id="rounds"></div>
    <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:800; padding-top:8px;">
      <span>Totaal</span><span id="total">0</span>
    </div>
  </div>

  <p><a href="scorebord.html">‚Üê Terug naar scorebord</a></p>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbCFR9XqM4nMvii1ZbzYpDcsoG8qONnw5w5MogMDWmwTNzCd7KhQ9kFw94jTGlWIWy6Vt-JsHsJokY/pub?gid=0&single=true&output=csv";

function roundNumberFromName(name){
  const m = String(name).toLowerCase().match(/r(?:onde)?\s*(\d+)/i);
  return m ? parseInt(m[1],10) : null;
}

async function fetchCSV(url){
  const res = await fetch(url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("CSV ophalen mislukt");
  return await res.text();
}

function parseCSV(text){
  const rows = text.trim().replace(/^\uFEFF/,"")
    .split(/\r?\n/)
    .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x => x.replace(/^"|"$/g, "").trim()));
  if(!rows.length) return { data:[], roundCols:[] };

  const headers = rows[0].map(h=>h.trim());
  const hLow    = headers.map(h=>h.toLowerCase());
  const teamIdx  = hLow.indexOf("team");
  const tokenIdx = hLow.indexOf("token");
  const scoreIdx = hLow.indexOf("score");

  const roundCols = headers
    .map((h,i)=>({label:h,i,nr:roundNumberFromName(h)}))
    .filter(o=>o.nr!==null)
    .sort((a,b)=>a.nr-b.nr);

  const data = rows.slice(1).map(r=>{
    const team  = teamIdx  >= 0 ? (r[teamIdx]  || "") : "";
    const token = tokenIdx >= 0 ? (r[tokenIdx] || "") : "";
    let total=0; const rounds=[];
    if(roundCols.length>0){
      for(const col of roundCols){
        const v = Number((r[col.i]||"0").toString().replace(",", "."))||0;
        rounds.push({label:col.label, value:v});
        total += v;
      }
    }else if(scoreIdx>=0){
      total = Number((r[scoreIdx]||"0").toString().replace(",", "."))||0;
    }
    return { team, token, rounds, total };
  }).filter(x=>x.team);

  // ranks
  const ranked = [...data].sort((a,b)=> b.total - a.total || a.team.localeCompare(b.team,'nl'));
  const rankMap = new Map(); let prev=null, rank=0;
  ranked.forEach((x,i)=>{ if(prev===null || x.total<prev) rank=i+1; rankMap.set(x.token||x.team, rank); prev=x.total; });

  return { data, roundCols, rankMap };
}

function renderTeam(dataset, keyValue){
  const key = keyValue.trim().toLowerCase();
  const item = dataset.data.find(x => (x.token||x.team).toLowerCase() === key);
  const title = document.getElementById("title");
  const roundsEl = document.getElementById("rounds");
  const totalEl = document.getElementById("total");
  const rankInfo = document.getElementById("rankInfo");

  if(!item){
    title.textContent = "Team niet gevonden";
    document.getElementById("subtitle").textContent = `Gezocht: ${keyValue}`;
    roundsEl.innerHTML = "<p>Vraag je QR/URL opnieuw aan bij de jury.</p>";
    return;
  }

  title.textContent = item.team;
  const rank = dataset.rankMap.get(item.token||item.team) || "-";
  rankInfo.textContent = `Positie: ${rank} / ${dataset.data.length}`;

  roundsEl.innerHTML = "";
  if (item.rounds.length === 0) {
    roundsEl.innerHTML = "<p class='muted'>Geen aparte rondekolommen gevonden.</p>";
  } else {
    const max = Math.max(1, ...item.rounds.map(r => r.value));
    item.rounds.forEach(r => {
      const row = document.createElement("div"); row.className="row";
      const left  = document.createElement("div"); left.textContent = r.label;
      const right = document.createElement("div"); right.textContent = r.value; right.style.minWidth="60px"; right.style.textAlign="right";
      const barWrap = document.createElement("div"); barWrap.className="bar-wrap";
      const bar = document.createElement("div"); bar.className="bar";
      bar.style.width = Math.round((r.value / max) * 100) + "%";
      barWrap.appendChild(bar);
      const wide = document.createElement("div"); wide.style.gridColumn = "1 / -1"; wide.appendChild(barWrap);
      row.appendChild(left); row.appendChild(right);
      roundsEl.appendChild(row); roundsEl.appendChild(wide);
    });
  }
  totalEl.textContent = item.total;
}

(async function(){
  try{
    const p = new URLSearchParams(location.search);
    const token = (p.get("t")||"").trim();
    const team  = (p.get("team")||"").trim();
    if(!token && !team) throw new Error("Geen team- of tokenparameter in de URL.");
    const csv = await fetchCSV(CSV_URL);
    const ds = parseCSV(csv);
    renderTeam(ds, token || team);
  }catch(e){
    document.getElementById("title").textContent = "Fout bij laden";
    document.getElementById("subtitle").textContent = e.message || e;
    console.error(e);
  }
})();
</script>
</body>
</html>